# jobs:
  backend-owasp-scan:
    executor: large-machine-executor
    working_directory: ~/tdp-apps
    steps:
      - checkout
      - docker-compose-check
      - docker-compose-up-backend
      - docker-compose-up-frontend
      - run:
          name: Wait for Django to become available
          command: |
            cd tdrs-backend;
            docker-compose run --rm zaproxy bash -c \
              "PATH=$PATH:/home/zap/.local/bin &&
               pip install wait-for-it &&
               wait-for-it --service http://web:8080 \
                           --timeout 60 \
                           -- echo \"Django is ready\""
      - run-owasp-scan:
          environment: circle
          target: backend

  frontend-owasp-scan:
    executor: large-machine-executor
    working_directory: ~/tdp-apps
    steps:
      - checkout
      - docker-compose-check
      - docker-compose-up-backend
      - docker-compose-up-frontend
      - run:
          name: Wait for frontend to become available
          command: |
            cd tdrs-frontend;
            docker-compose run --rm zaproxy bash -c \
              "PATH=$PATH:/home/zap/.local/bin &&
               pip install wait-for-it &&
               wait-for-it --service http://tdp-frontend/ \
                           --timeout 60 \
                           -- echo \"Frontend is ready\""
      - run-owasp-scan:
          environment: circle
          target: frontend

  nightly-owasp-scan:
    executor: large-machine-executor
    working_directory: ~/tdp-apps
    parameters:
      cf_password:
        type: string
        default: CF_PASSWORD_STAGING
      cf_username:
        type: string
        default: CF_USERNAME_STAGING
      cf_space:
        type: string
        default: tanf-staging
      cf_org:
        type: string
        default: "CF_ORG"
      target_env:
        type: enum
        enum: [ "staging", "develop", "prod" ]
    steps:
      - checkout
      - sudo-check
      - cf-check
      - docker-compose-check
      - login-cloud-dot-gov:
          cf-password: <<parameters.cf_password>>
          cf-username: <<parameters.cf_username>>
          cf-org: <<parameters.cf_org>>
          cf-space: <<parameters.cf_space>>
      - run-owasp-scan:
          environment: nightly
          target: backend
          target_env: <<parameters.target_env>>
      - run-owasp-scan:
          environment: nightly
          target: frontend
          target_env: <<parameters.target_env>>
      - run:
          name: Print BASH_ENV Contents
          command: cat $BASH_ENV
      - run:
          name: Run post-processing task to record OWASP ZAP results
          command: |
            # Change to the correct directory where manage.py is located
            cd /home/circleci/tdp-apps/tdrs-backend

            python3 manage.py process_owasp_scan $CIRCLE_BUILD_NUM \
            --backend-pass-count $ZAP_BACKEND_PASS_COUNT \
            --backend-warn-count $ZAP_BACKEND_WARN_COUNT \
            --backend-fail-count $ZAP_BACKEND_FAIL_COUNT \
            --frontend-pass-count $ZAP_FRONTEND_PASS_COUNT \
            --frontend-warn-count $ZAP_FRONTEND_WARN_COUNT \
            --frontend-fail-count $ZAP_FRONTEND_FAIL_COUNT \
            --project-slug "${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"
